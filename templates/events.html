<html>
    <head>
        <title>Events</title>

        <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icon-css@3.5.0/css/flag-icon.min.css">

        <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            .collapsible li i {
                transition: 200ms;
            }
            .collapsible li.active i {
                transform: rotate(180deg);

                transition: 200ms;
            }
        </style>
    </head>
    <body>
        <nav class="light-blue">
            <div class="nav-wrapper container">
                <a href="/" id="brand-logo" class="white-text brand-logo">4x4sport.info</a>
                <i class="material-icons right">account_box</i>
            </div>
        </nav>

        <div class="container">
            <ul class="collapsible">
                <li>
                    <div class="collapsible-header center" style="display: block;">
                        <i id="search-collapse" class="material-icons">expand_more</i>
                    </div>
                    <div class="collapsible-body">
                        <form id="search-form">
                            <label>Name:</label>
                            <input name="name" type="text">
                            <label>Maximum Distance</label>
                            <p class="range-field">
                                <input name="range" type="range" min="0" step="100" max="10000">
                            </p>
                            <div class="input-field col s12">
                                <label id="type-label">Types:</label>
                                <select name="types" id="type-select" multiple>
                                    <option value="trophy" selected>Trophy</option>
                                    <option value="rallye" selected>Rallye</option>
                                    <option value="trial" selected>Trial</option>
                                    <option value="meeting" selected>Meeting</option>
                                    <option value="free-driving" selected>Free Driving</option>
                                </select>
                            </div>
                            <label>
                                <input type="checkbox" class="filled-in" checked="checked" name="future" id="future-select"/>
                                <span>Only show future events</span>
                            </label>
                        </form>
                    </div>
                </li>
            </ul>
            <table id="content-table">
                <tr>
                    <th>Name</th>
                    <th>Start Date</th>
                    <th>Duration</th>
                    <th>Country</th>
                </tr>
            </table>
        </div>
    </body>
    <script>
        // Init
        $(document).ready(function() {
            $(".collapsible").collapsible();
            $("input[type=range]").range();
            $("select").formSelect();
            $(".tooltipped").tooltip();
        });

        // Type Select
        $("#type-label").css("opacity", 0);
        $("#type-select").change(function() {
            $("#type-label").css("opacity", $("#type-select").val().length == 0 ? 1 : 0);
        });

        // AJAX
        $("#search-form").change(function() {
            let query = "?";
            query += "name=" + $("[name=name]").val();
            query += "&range=" + $("[name=range]").val();
            query += "&types=" + $("[name=types]").val();
            query += "&future=" + $("[name=future]").prop("checked");

            ajax(query);
        });

        function ajax(query) {
            let xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200) {
                    let data = JSON.parse(this.responseText);

                    $(".event").remove();
                    if(data.length == 0) $("#content-table").append("<tr class=\"event\"><td class=\"center\" colspan=\"4\">No Events Found.</td></tr>");

                    for(const event of data) {
                        $("#content-table").append(`
                            <tr class="event">
                                <td>${event.name}</td>
                                <td>${event.start}</td>
                                <td>${event.duration}</td>
                                <td><span class="flag-icon flag-icon-${event.country}"></span> ${event.country.toUpperCase()}</td>
                            </tr>
                        `);
                    }
                }
            };

            xhr.open("GET", "/query" + query, true);
            xhr.send();
        }

        // First AJAX
        ajax("?");
    </script>
</html>